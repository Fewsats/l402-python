# payment clients


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

``` python
chain = 'base-mainnet'
```

------------------------------------------------------------------------

<a
href="https://github.com/Fewsats/l402-python/blob/main/l402/payment_clients.py#L32"
target="_blank" style="float:right; font-size:smaller">source</a>

### PaymentRequest

>  PaymentRequest (offer_id:str, payment_context_token:str,
>                      payment_method:str, chain:str='', asset:str='')

*Represents a payment request to get payment details from a payment
provider*

------------------------------------------------------------------------

<a
href="https://github.com/Fewsats/l402-python/blob/main/l402/payment_clients.py#L24"
target="_blank" style="float:right; font-size:smaller">source</a>

### PaymentProvider

>  PaymentProvider ()

*Base class for all payment providers*

``` python
# from l402.utils import *

# run_l402_server(PaymentRequest, port=9000)
```

## Coinbase Provider

------------------------------------------------------------------------

<a
href="https://github.com/Fewsats/l402-python/blob/main/l402/payment_clients.py#L44"
target="_blank" style="float:right; font-size:smaller">source</a>

### CoinbaseProvider

>  CoinbaseProvider (wallet:cdp.wallet.Wallet, asset:str='usdc')

*Base class for objects needing a basic `__repr__`*

``` python
c = CoinbaseProvider(wallet=create_test_wallet(fund=False, chain=chain))
c
```

    CoinbaseProvider(wallet=Wallet: (id: ef60974b-2571-44ca-ac25-ff99d2e3c88f, network_id: base-mainnet, server_signer_status: None), asset='usdc', supported_methods=['onchain'], chain='base-mainnet')

``` python
r = httpx.get('https://l402-offers.replit.app')
# r = httpx.get('http://localhost:9000/offers')
r.status_code, r.text
```

    (402,
     '{"offers":[{"offer_id":"ce23eefd-1156-4aa4-85c1-361918a24485","amount":1,"currency":"USD","description":"Purchase 1 credit for API access","title":"1 Credit Package","type":"one-time","payment_methods":["onchain","lightning"]}],"payment_context_token":"8ee0082b-97c8-4ac6-baa4-f9f544dc977c","payment_request_url":"https://hub-5n97k.ondigitalocean.app/v0/l402/payment-request","version":"0.2.2"}')

``` python
o = r.json()
o
```

    {'offers': [{'offer_id': 'ce23eefd-1156-4aa4-85c1-361918a24485',
       'amount': 1,
       'currency': 'USD',
       'description': 'Purchase 1 credit for API access',
       'title': '1 Credit Package',
       'type': 'one-time',
       'payment_methods': ['onchain', 'lightning']}],
     'payment_context_token': '8ee0082b-97c8-4ac6-baa4-f9f544dc977c',
     'payment_request_url': 'https://hub-5n97k.ondigitalocean.app/v0/l402/payment-request',
     'version': '0.2.2'}

``` python
data = {
    "offer_id": first(o['offers'])['offer_id'],
    "payment_method": 'onchain',
    "chain": chain,
    "asset": 'usdc',
    "payment_context_token": o['payment_context_token']
    }
r = httpx.post(o['payment_request_url'], json=data)
r.status_code, r.json()
```

    (200,
     {'expires_at': '2025-01-28T02:06:17.637705+00:00',
      'offer_id': 'ce23eefd-1156-4aa4-85c1-361918a24485',
      'payment_request': {'checkout_url': 'https://commerce.coinbase.com/pay/be427ef1-153a-495e-93eb-1b10550731d0',
       'address': '0x03059433BCdB6144624cC2443159D9445C32b7a8',
       'chain': 'base-mainnet',
       'asset': 'usdc'},
      'version': '0.2.2'})

``` python
data = {
    "offer_id": first(o['offers'])['offer_id'],
    "payment_method": 'lightning',
    "payment_context_token": o['payment_context_token']
    }
r = httpx.post(o['payment_request_url'], json=data, timeout=15)
r.status_code, r.text
```

    (200,
     '{"expires_at": "2025-01-28T04:14:16.328280+00:00", "offer_id": "ce23eefd-1156-4aa4-85c1-361918a24485", "payment_request": {"lightning_invoice": "lnbc90n1pnes5txpp5zxhg46zr2lycmqg9km930h9mmefeyanw3jm8c2cxpqxlhlvevkgsdq6xysyxun9v35hggzsv93kkct8v5cqzpgxqrzpjrzjqwghf7zxvfkxq5a6sr65g0gdkv768p83mhsnt0msszapamzx2qvuxqqqqz99gpz55yqqqqqqqqqqqqqq9qrzjq25carzepgd4vqsyn44jrk85ezrpju92xyrk9apw4cdjh6yrwt5jgqqqqz99gpz55yqqqqqqqqqqqqqq9qsp5y9unj8j6czfjy274dj7war7k7xey8jvgegsxcjenct8ntah4eyvs9qxpqysgqq60qg26s74k4jsetcz954dlpghg63a8qrprqytr0ml0f2hxtfm0zujk4t54x2n4hxaxaz6d75tm7xjalv287mn559uq8tnmyfs92gdqpdutj9l"}, "version": "0.2.2"}')

``` python
data = {
    "offer_id": 'test-lightning-1',
    "payment_method": 'lightning',
    "payment_context_token": '550cdc77-bdae-410b-bd7a-091b14be72bb'
    }
r = httpx.post('http://localhost:8000/v0/l402/payment-request', json=data, timeout=15)
r.status_code, r.text
```

    (200,
     '{"expires_at": "2025-01-28T02:46:35.422815+00:00", "offer_id": "test-lightning-1", "payment_request": {"lightning_invoice": "lnbc90n1pnes0xhpp5lsp46vm2j47f8z3rm3lmj2lh54gvc4jn3hql0qhp9ryxef9fz0lsdpy23jhxapqf35kw6r5de5kueeq2pshjmt9de6qcqzpgxqrzpnrzjqwghf7zxvfkxq5a6sr65g0gdkv768p83mhsnt0msszapamzx2qvuxqqqqz99gpz55yqqqqqqqqqqqqqq9qrzjq25carzepgd4vqsyn44jrk85ezrpju92xyrk9apw4cdjh6yrwt5jgqqqqz99gpz55yqqqqqqqqqqqqqq9qsp5ykrsqs0x9mjt22937a0hn5wz0z0fxd9yxv97sud2kkrswuakh2js9qxpqysgqeq8g08w8n3t0wlhj3h3zkjsnpa8gznzncf98nqk92lyd96a30gsy8fxzk5q9z47fsy59ljn548xlck84qeta88wygppq3zed8qsz9dgqxn7rtq"}, "version": "0.2.2"}')

------------------------------------------------------------------------

<a
href="https://github.com/Fewsats/l402-python/blob/main/l402/payment_clients.py#L60"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_payment_request

>  get_payment_request (payment_request_url:str, payment_context_token:str,
>                           offer_id:str, payment_method:str, chain:str='',
>                           asset:str='')

``` python
r = get_payment_request(o['payment_request_url'], o['payment_context_token'], o['offers'][0]['offer_id'], 'onchain', chain, 'usdc')
r
```

    ReadTimeout: The read operation timed out
    [0;31m---------------------------------------------------------------------------[0m
    [0;31mReadTimeout[0m                               Traceback (most recent call last)
    File [0;32m~/go/github.com/Fewsats/l402-python/venv/lib/python3.12/site-packages/httpx/_transports/default.py:101[0m, in [0;36mmap_httpcore_exceptions[0;34m()[0m
    [1;32m    100[0m [38;5;28;01mtry[39;00m:
    [0;32m--> 101[0m     [38;5;28;01myield[39;00m
    [1;32m    102[0m [38;5;28;01mexcept[39;00m [38;5;167;01mException[39;00m [38;5;28;01mas[39;00m exc:

    File [0;32m~/go/github.com/Fewsats/l402-python/venv/lib/python3.12/site-packages/httpx/_transports/default.py:250[0m, in [0;36mHTTPTransport.handle_request[0;34m(self, request)[0m
    [1;32m    249[0m [38;5;28;01mwith[39;00m map_httpcore_exceptions():
    [0;32m--> 250[0m     resp [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_pool[49m[38;5;241;43m.[39;49m[43mhandle_request[49m[43m([49m[43mreq[49m[43m)[49m
    [1;32m    252[0m [38;5;28;01massert[39;00m [38;5;28misinstance[39m(resp[38;5;241m.[39mstream, typing[38;5;241m.[39mIterable)

    File [0;32m~/go/github.com/Fewsats/l402-python/venv/lib/python3.12/site-packages/httpcore/_sync/connection_pool.py:256[0m, in [0;36mConnectionPool.handle_request[0;34m(self, request)[0m
    [1;32m    255[0m     [38;5;28mself[39m[38;5;241m.[39m_close_connections(closing)
    [0;32m--> 256[0m     [38;5;28;01mraise[39;00m exc [38;5;28;01mfrom[39;00m[38;5;250m [39m[38;5;28;01mNone[39;00m
    [1;32m    258[0m [38;5;66;03m# Return the response. Note that in this case we still have to manage[39;00m
    [1;32m    259[0m [38;5;66;03m# the point at which the response is closed.[39;00m

    File [0;32m~/go/github.com/Fewsats/l402-python/venv/lib/python3.12/site-packages/httpcore/_sync/connection_pool.py:236[0m, in [0;36mConnectionPool.handle_request[0;34m(self, request)[0m
    [1;32m    234[0m [38;5;28;01mtry[39;00m:
    [1;32m    235[0m     [38;5;66;03m# Send the request on the assigned connection.[39;00m
    [0;32m--> 236[0m     response [38;5;241m=[39m [43mconnection[49m[38;5;241;43m.[39;49m[43mhandle_request[49m[43m([49m
    [1;32m    237[0m [43m        [49m[43mpool_request[49m[38;5;241;43m.[39;49m[43mrequest[49m
    [1;32m    238[0m [43m    [49m[43m)[49m
    [1;32m    239[0m [38;5;28;01mexcept[39;00m ConnectionNotAvailable:
    [1;32m    240[0m     [38;5;66;03m# In some cases a connection may initially be available to[39;00m
    [1;32m    241[0m     [38;5;66;03m# handle a request, but then become unavailable.[39;00m
    [1;32m    242[0m     [38;5;66;03m#[39;00m
    [1;32m    243[0m     [38;5;66;03m# In this case we clear the connection and try again.[39;00m

    File [0;32m~/go/github.com/Fewsats/l402-python/venv/lib/python3.12/site-packages/httpcore/_sync/connection.py:103[0m, in [0;36mHTTPConnection.handle_request[0;34m(self, request)[0m
    [1;32m    101[0m     [38;5;28;01mraise[39;00m exc
    [0;32m--> 103[0m [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_connection[49m[38;5;241;43m.[39;49m[43mhandle_request[49m[43m([49m[43mrequest[49m[43m)[49m

    File [0;32m~/go/github.com/Fewsats/l402-python/venv/lib/python3.12/site-packages/httpcore/_sync/http11.py:136[0m, in [0;36mHTTP11Connection.handle_request[0;34m(self, request)[0m
    [1;32m    135[0m         [38;5;28mself[39m[38;5;241m.[39m_response_closed()
    [0;32m--> 136[0m [38;5;28;01mraise[39;00m exc

    File [0;32m~/go/github.com/Fewsats/l402-python/venv/lib/python3.12/site-packages/httpcore/_sync/http11.py:106[0m, in [0;36mHTTP11Connection.handle_request[0;34m(self, request)[0m
    [1;32m     97[0m [38;5;28;01mwith[39;00m Trace(
    [1;32m     98[0m     [38;5;124m"[39m[38;5;124mreceive_response_headers[39m[38;5;124m"[39m, logger, request, kwargs
    [1;32m     99[0m ) [38;5;28;01mas[39;00m trace:
    [1;32m    100[0m     (
    [1;32m    101[0m         http_version,
    [1;32m    102[0m         status,
    [1;32m    103[0m         reason_phrase,
    [1;32m    104[0m         headers,
    [1;32m    105[0m         trailing_data,
    [0;32m--> 106[0m     ) [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_receive_response_headers[49m[43m([49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mkwargs[49m[43m)[49m
    [1;32m    107[0m     trace[38;5;241m.[39mreturn_value [38;5;241m=[39m (
    [1;32m    108[0m         http_version,
    [1;32m    109[0m         status,
    [1;32m    110[0m         reason_phrase,
    [1;32m    111[0m         headers,
    [1;32m    112[0m     )

    File [0;32m~/go/github.com/Fewsats/l402-python/venv/lib/python3.12/site-packages/httpcore/_sync/http11.py:177[0m, in [0;36mHTTP11Connection._receive_response_headers[0;34m(self, request)[0m
    [1;32m    176[0m [38;5;28;01mwhile[39;00m [38;5;28;01mTrue[39;00m:
    [0;32m--> 177[0m     event [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_receive_event[49m[43m([49m[43mtimeout[49m[38;5;241;43m=[39;49m[43mtimeout[49m[43m)[49m
    [1;32m    178[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(event, h11[38;5;241m.[39mResponse):

    File [0;32m~/go/github.com/Fewsats/l402-python/venv/lib/python3.12/site-packages/httpcore/_sync/http11.py:217[0m, in [0;36mHTTP11Connection._receive_event[0;34m(self, timeout)[0m
    [1;32m    216[0m [38;5;28;01mif[39;00m event [38;5;129;01mis[39;00m h11[38;5;241m.[39mNEED_DATA:
    [0;32m--> 217[0m     data [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_network_stream[49m[38;5;241;43m.[39;49m[43mread[49m[43m([49m
    [1;32m    218[0m [43m        [49m[38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mREAD_NUM_BYTES[49m[43m,[49m[43m [49m[43mtimeout[49m[38;5;241;43m=[39;49m[43mtimeout[49m
    [1;32m    219[0m [43m    [49m[43m)[49m
    [1;32m    221[0m     [38;5;66;03m# If we feed this case through h11 we'll raise an exception like:[39;00m
    [1;32m    222[0m     [38;5;66;03m#[39;00m
    [1;32m    223[0m     [38;5;66;03m#     httpcore.RemoteProtocolError: can't handle event type[39;00m
    [0;32m   (...)[0m
    [1;32m    227[0m     [38;5;66;03m# perspective. Instead we handle this case distinctly and treat[39;00m
    [1;32m    228[0m     [38;5;66;03m# it as a ConnectError.[39;00m

    File [0;32m~/go/github.com/Fewsats/l402-python/venv/lib/python3.12/site-packages/httpcore/_backends/sync.py:126[0m, in [0;36mSyncStream.read[0;34m(self, max_bytes, timeout)[0m
    [1;32m    125[0m exc_map: ExceptionMapping [38;5;241m=[39m {socket[38;5;241m.[39mtimeout: ReadTimeout, [38;5;167;01mOSError[39;00m: ReadError}
    [0;32m--> 126[0m [43m[49m[38;5;28;43;01mwith[39;49;00m[43m [49m[43mmap_exceptions[49m[43m([49m[43mexc_map[49m[43m)[49m[43m:[49m
    [1;32m    127[0m [43m    [49m[38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_sock[49m[38;5;241;43m.[39;49m[43msettimeout[49m[43m([49m[43mtimeout[49m[43m)[49m

    File [0;32m/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158[0m, in [0;36m_GeneratorContextManager.__exit__[0;34m(self, typ, value, traceback)[0m
    [1;32m    157[0m [38;5;28;01mtry[39;00m:
    [0;32m--> 158[0m     [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mgen[49m[38;5;241;43m.[39;49m[43mthrow[49m[43m([49m[43mvalue[49m[43m)[49m
    [1;32m    159[0m [38;5;28;01mexcept[39;00m [38;5;167;01mStopIteration[39;00m [38;5;28;01mas[39;00m exc:
    [1;32m    160[0m     [38;5;66;03m# Suppress StopIteration *unless* it's the same exception that[39;00m
    [1;32m    161[0m     [38;5;66;03m# was passed to throw().  This prevents a StopIteration[39;00m
    [1;32m    162[0m     [38;5;66;03m# raised inside the "with" statement from being suppressed.[39;00m

    File [0;32m~/go/github.com/Fewsats/l402-python/venv/lib/python3.12/site-packages/httpcore/_exceptions.py:14[0m, in [0;36mmap_exceptions[0;34m(map)[0m
    [1;32m     13[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(exc, from_exc):
    [0;32m---> 14[0m         [38;5;28;01mraise[39;00m to_exc(exc) [38;5;28;01mfrom[39;00m[38;5;250m [39m[38;5;21;01mexc[39;00m
    [1;32m     15[0m [38;5;28;01mraise[39;00m

    [0;31mReadTimeout[0m: The read operation timed out

    The above exception was the direct cause of the following exception:

    [0;31mReadTimeout[0m                               Traceback (most recent call last)
    Cell [0;32mIn[13], line 1[0m
    [0;32m----> 1[0m r [38;5;241m=[39m [43mget_payment_request[49m[43m([49m[43mo[49m[43m[[49m[38;5;124;43m'[39;49m[38;5;124;43mpayment_request_url[39;49m[38;5;124;43m'[39;49m[43m][49m[43m,[49m[43m [49m[43mo[49m[43m[[49m[38;5;124;43m'[39;49m[38;5;124;43mpayment_context_token[39;49m[38;5;124;43m'[39;49m[43m][49m[43m,[49m[43m [49m[43mo[49m[43m[[49m[38;5;124;43m'[39;49m[38;5;124;43moffers[39;49m[38;5;124;43m'[39;49m[43m][49m[43m[[49m[38;5;241;43m0[39;49m[43m][49m[43m[[49m[38;5;124;43m'[39;49m[38;5;124;43moffer_id[39;49m[38;5;124;43m'[39;49m[43m][49m[43m,[49m[43m [49m[38;5;124;43m'[39;49m[38;5;124;43monchain[39;49m[38;5;124;43m'[39;49m[43m,[49m[43m [49m[43mchain[49m[43m,[49m[43m [49m[38;5;124;43m'[39;49m[38;5;124;43musdc[39;49m[38;5;124;43m'[39;49m[43m)[49m
    [1;32m      2[0m r

    Cell [0;32mIn[12], line 16[0m, in [0;36mget_payment_request[0;34m(payment_request_url, payment_context_token, offer_id, payment_method, chain, asset)[0m
    [1;32m      3[0m [38;5;28;01mdef[39;00m[38;5;250m [39m[38;5;21mget_payment_request[39m(payment_request_url: [38;5;28mstr[39m,
    [1;32m      4[0m                         payment_context_token: [38;5;28mstr[39m,
    [1;32m      5[0m                         offer_id: [38;5;28mstr[39m, 
    [1;32m      6[0m                         payment_method: [38;5;28mstr[39m, 
    [1;32m      7[0m                         chain: [38;5;28mstr[39m [38;5;241m=[39m [38;5;124m"[39m[38;5;124m"[39m, 
    [1;32m      8[0m                         asset: [38;5;28mstr[39m [38;5;241m=[39m [38;5;124m"[39m[38;5;124m"[39m):
    [1;32m      9[0m     data [38;5;241m=[39m {
    [1;32m     10[0m         [38;5;124m"[39m[38;5;124moffer_id[39m[38;5;124m"[39m: offer_id,
    [1;32m     11[0m         [38;5;124m"[39m[38;5;124mpayment_method[39m[38;5;124m"[39m: payment_method,
    [0;32m   (...)[0m
    [1;32m     14[0m         [38;5;124m"[39m[38;5;124mpayment_context_token[39m[38;5;124m"[39m: payment_context_token
    [1;32m     15[0m     }
    [0;32m---> 16[0m     r [38;5;241m=[39m [43mhttpx[49m[38;5;241;43m.[39;49m[43mpost[49m[43m([49m[43mpayment_request_url[49m[43m,[49m[43m [49m[43mjson[49m[38;5;241;43m=[39;49m[43mdata[49m[43m)[49m
    [1;32m     17[0m     r[38;5;241m.[39mraise_for_status()
    [1;32m     18[0m     [38;5;28;01mreturn[39;00m r[38;5;241m.[39mjson()

    File [0;32m~/go/github.com/Fewsats/l402-python/venv/lib/python3.12/site-packages/httpx/_api.py:304[0m, in [0;36mpost[0;34m(url, content, data, files, json, params, headers, cookies, auth, proxy, follow_redirects, verify, timeout, trust_env)[0m
    [1;32m    282[0m [38;5;28;01mdef[39;00m[38;5;250m [39m[38;5;21mpost[39m(
    [1;32m    283[0m     url: URL [38;5;241m|[39m [38;5;28mstr[39m,
    [1;32m    284[0m     [38;5;241m*[39m,
    [0;32m   (...)[0m
    [1;32m    297[0m     trust_env: [38;5;28mbool[39m [38;5;241m=[39m [38;5;28;01mTrue[39;00m,
    [1;32m    298[0m ) [38;5;241m-[39m[38;5;241m>[39m Response:
    [1;32m    299[0m [38;5;250m    [39m[38;5;124;03m"""[39;00m
    [1;32m    300[0m [38;5;124;03m    Sends a `POST` request.[39;00m
    [1;32m    301[0m 
    [1;32m    302[0m [38;5;124;03m    **Parameters**: See `httpx.request`.[39;00m
    [1;32m    303[0m [38;5;124;03m    """[39;00m
    [0;32m--> 304[0m     [38;5;28;01mreturn[39;00m [43mrequest[49m[43m([49m
    [1;32m    305[0m [43m        [49m[38;5;124;43m"[39;49m[38;5;124;43mPOST[39;49m[38;5;124;43m"[39;49m[43m,[49m
    [1;32m    306[0m [43m        [49m[43murl[49m[43m,[49m
    [1;32m    307[0m [43m        [49m[43mcontent[49m[38;5;241;43m=[39;49m[43mcontent[49m[43m,[49m
    [1;32m    308[0m [43m        [49m[43mdata[49m[38;5;241;43m=[39;49m[43mdata[49m[43m,[49m
    [1;32m    309[0m [43m        [49m[43mfiles[49m[38;5;241;43m=[39;49m[43mfiles[49m[43m,[49m
    [1;32m    310[0m [43m        [49m[43mjson[49m[38;5;241;43m=[39;49m[43mjson[49m[43m,[49m
    [1;32m    311[0m [43m        [49m[43mparams[49m[38;5;241;43m=[39;49m[43mparams[49m[43m,[49m
    [1;32m    312[0m [43m        [49m[43mheaders[49m[38;5;241;43m=[39;49m[43mheaders[49m[43m,[49m
    [1;32m    313[0m [43m        [49m[43mcookies[49m[38;5;241;43m=[39;49m[43mcookies[49m[43m,[49m
    [1;32m    314[0m [43m        [49m[43mauth[49m[38;5;241;43m=[39;49m[43mauth[49m[43m,[49m
    [1;32m    315[0m [43m        [49m[43mproxy[49m[38;5;241;43m=[39;49m[43mproxy[49m[43m,[49m
    [1;32m    316[0m [43m        [49m[43mfollow_redirects[49m[38;5;241;43m=[39;49m[43mfollow_redirects[49m[43m,[49m
    [1;32m    317[0m [43m        [49m[43mverify[49m[38;5;241;43m=[39;49m[43mverify[49m[43m,[49m
    [1;32m    318[0m [43m        [49m[43mtimeout[49m[38;5;241;43m=[39;49m[43mtimeout[49m[43m,[49m
    [1;32m    319[0m [43m        [49m[43mtrust_env[49m[38;5;241;43m=[39;49m[43mtrust_env[49m[43m,[49m
    [1;32m    320[0m [43m    [49m[43m)[49m

    File [0;32m~/go/github.com/Fewsats/l402-python/venv/lib/python3.12/site-packages/httpx/_api.py:109[0m, in [0;36mrequest[0;34m(method, url, params, content, data, files, json, headers, cookies, auth, proxy, timeout, follow_redirects, verify, trust_env)[0m
    [1;32m     57[0m [38;5;250m[39m[38;5;124;03m"""[39;00m
    [1;32m     58[0m [38;5;124;03mSends an HTTP request.[39;00m
    [1;32m     59[0m 
    [0;32m   (...)[0m
    [1;32m    100[0m [38;5;124;03m```[39;00m
    [1;32m    101[0m [38;5;124;03m"""[39;00m
    [1;32m    102[0m [38;5;28;01mwith[39;00m Client(
    [1;32m    103[0m     cookies[38;5;241m=[39mcookies,
    [1;32m    104[0m     proxy[38;5;241m=[39mproxy,
    [0;32m   (...)[0m
    [1;32m    107[0m     trust_env[38;5;241m=[39mtrust_env,
    [1;32m    108[0m ) [38;5;28;01mas[39;00m client:
    [0;32m--> 109[0m     [38;5;28;01mreturn[39;00m [43mclient[49m[38;5;241;43m.[39;49m[43mrequest[49m[43m([49m
    [1;32m    110[0m [43m        [49m[43mmethod[49m[38;5;241;43m=[39;49m[43mmethod[49m[43m,[49m
    [1;32m    111[0m [43m        [49m[43murl[49m[38;5;241;43m=[39;49m[43murl[49m[43m,[49m
    [1;32m    112[0m [43m        [49m[43mcontent[49m[38;5;241;43m=[39;49m[43mcontent[49m[43m,[49m
    [1;32m    113[0m [43m        [49m[43mdata[49m[38;5;241;43m=[39;49m[43mdata[49m[43m,[49m
    [1;32m    114[0m [43m        [49m[43mfiles[49m[38;5;241;43m=[39;49m[43mfiles[49m[43m,[49m
    [1;32m    115[0m [43m        [49m[43mjson[49m[38;5;241;43m=[39;49m[43mjson[49m[43m,[49m
    [1;32m    116[0m [43m        [49m[43mparams[49m[38;5;241;43m=[39;49m[43mparams[49m[43m,[49m
    [1;32m    117[0m [43m        [49m[43mheaders[49m[38;5;241;43m=[39;49m[43mheaders[49m[43m,[49m
    [1;32m    118[0m [43m        [49m[43mauth[49m[38;5;241;43m=[39;49m[43mauth[49m[43m,[49m
    [1;32m    119[0m [43m        [49m[43mfollow_redirects[49m[38;5;241;43m=[39;49m[43mfollow_redirects[49m[43m,[49m
    [1;32m    120[0m [43m    [49m[43m)[49m

    File [0;32m~/go/github.com/Fewsats/l402-python/venv/lib/python3.12/site-packages/httpx/_client.py:825[0m, in [0;36mClient.request[0;34m(self, method, url, content, data, files, json, params, headers, cookies, auth, follow_redirects, timeout, extensions)[0m
    [1;32m    810[0m     warnings[38;5;241m.[39mwarn(message, [38;5;167;01mDeprecationWarning[39;00m, stacklevel[38;5;241m=[39m[38;5;241m2[39m)
    [1;32m    812[0m request [38;5;241m=[39m [38;5;28mself[39m[38;5;241m.[39mbuild_request(
    [1;32m    813[0m     method[38;5;241m=[39mmethod,
    [1;32m    814[0m     url[38;5;241m=[39murl,
    [0;32m   (...)[0m
    [1;32m    823[0m     extensions[38;5;241m=[39mextensions,
    [1;32m    824[0m )
    [0;32m--> 825[0m [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msend[49m[43m([49m[43mrequest[49m[43m,[49m[43m [49m[43mauth[49m[38;5;241;43m=[39;49m[43mauth[49m[43m,[49m[43m [49m[43mfollow_redirects[49m[38;5;241;43m=[39;49m[43mfollow_redirects[49m[43m)[49m

    File [0;32m~/go/github.com/Fewsats/l402-python/venv/lib/python3.12/site-packages/httpx/_client.py:914[0m, in [0;36mClient.send[0;34m(self, request, stream, auth, follow_redirects)[0m
    [1;32m    910[0m [38;5;28mself[39m[38;5;241m.[39m_set_timeout(request)
    [1;32m    912[0m auth [38;5;241m=[39m [38;5;28mself[39m[38;5;241m.[39m_build_request_auth(request, auth)
    [0;32m--> 914[0m response [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_send_handling_auth[49m[43m([49m
    [1;32m    915[0m [43m    [49m[43mrequest[49m[43m,[49m
    [1;32m    916[0m [43m    [49m[43mauth[49m[38;5;241;43m=[39;49m[43mauth[49m[43m,[49m
    [1;32m    917[0m [43m    [49m[43mfollow_redirects[49m[38;5;241;43m=[39;49m[43mfollow_redirects[49m[43m,[49m
    [1;32m    918[0m [43m    [49m[43mhistory[49m[38;5;241;43m=[39;49m[43m[[49m[43m][49m[43m,[49m
    [1;32m    919[0m [43m[49m[43m)[49m
    [1;32m    920[0m [38;5;28;01mtry[39;00m:
    [1;32m    921[0m     [38;5;28;01mif[39;00m [38;5;129;01mnot[39;00m stream:

    File [0;32m~/go/github.com/Fewsats/l402-python/venv/lib/python3.12/site-packages/httpx/_client.py:942[0m, in [0;36mClient._send_handling_auth[0;34m(self, request, auth, follow_redirects, history)[0m
    [1;32m    939[0m request [38;5;241m=[39m [38;5;28mnext[39m(auth_flow)
    [1;32m    941[0m [38;5;28;01mwhile[39;00m [38;5;28;01mTrue[39;00m:
    [0;32m--> 942[0m     response [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_send_handling_redirects[49m[43m([49m
    [1;32m    943[0m [43m        [49m[43mrequest[49m[43m,[49m
    [1;32m    944[0m [43m        [49m[43mfollow_redirects[49m[38;5;241;43m=[39;49m[43mfollow_redirects[49m[43m,[49m
    [1;32m    945[0m [43m        [49m[43mhistory[49m[38;5;241;43m=[39;49m[43mhistory[49m[43m,[49m
    [1;32m    946[0m [43m    [49m[43m)[49m
    [1;32m    947[0m     [38;5;28;01mtry[39;00m:
    [1;32m    948[0m         [38;5;28;01mtry[39;00m:

    File [0;32m~/go/github.com/Fewsats/l402-python/venv/lib/python3.12/site-packages/httpx/_client.py:979[0m, in [0;36mClient._send_handling_redirects[0;34m(self, request, follow_redirects, history)[0m
    [1;32m    976[0m [38;5;28;01mfor[39;00m hook [38;5;129;01min[39;00m [38;5;28mself[39m[38;5;241m.[39m_event_hooks[[38;5;124m"[39m[38;5;124mrequest[39m[38;5;124m"[39m]:
    [1;32m    977[0m     hook(request)
    [0;32m--> 979[0m response [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_send_single_request[49m[43m([49m[43mrequest[49m[43m)[49m
    [1;32m    980[0m [38;5;28;01mtry[39;00m:
    [1;32m    981[0m     [38;5;28;01mfor[39;00m hook [38;5;129;01min[39;00m [38;5;28mself[39m[38;5;241m.[39m_event_hooks[[38;5;124m"[39m[38;5;124mresponse[39m[38;5;124m"[39m]:

    File [0;32m~/go/github.com/Fewsats/l402-python/venv/lib/python3.12/site-packages/httpx/_client.py:1014[0m, in [0;36mClient._send_single_request[0;34m(self, request)[0m
    [1;32m   1009[0m     [38;5;28;01mraise[39;00m [38;5;167;01mRuntimeError[39;00m(
    [1;32m   1010[0m         [38;5;124m"[39m[38;5;124mAttempted to send an async request with a sync Client instance.[39m[38;5;124m"[39m
    [1;32m   1011[0m     )
    [1;32m   1013[0m [38;5;28;01mwith[39;00m request_context(request[38;5;241m=[39mrequest):
    [0;32m-> 1014[0m     response [38;5;241m=[39m [43mtransport[49m[38;5;241;43m.[39;49m[43mhandle_request[49m[43m([49m[43mrequest[49m[43m)[49m
    [1;32m   1016[0m [38;5;28;01massert[39;00m [38;5;28misinstance[39m(response[38;5;241m.[39mstream, SyncByteStream)
    [1;32m   1018[0m response[38;5;241m.[39mrequest [38;5;241m=[39m request

    File [0;32m~/go/github.com/Fewsats/l402-python/venv/lib/python3.12/site-packages/httpx/_transports/default.py:249[0m, in [0;36mHTTPTransport.handle_request[0;34m(self, request)[0m
    [1;32m    235[0m [38;5;28;01mimport[39;00m[38;5;250m [39m[38;5;21;01mhttpcore[39;00m
    [1;32m    237[0m req [38;5;241m=[39m httpcore[38;5;241m.[39mRequest(
    [1;32m    238[0m     method[38;5;241m=[39mrequest[38;5;241m.[39mmethod,
    [1;32m    239[0m     url[38;5;241m=[39mhttpcore[38;5;241m.[39mURL(
    [0;32m   (...)[0m
    [1;32m    247[0m     extensions[38;5;241m=[39mrequest[38;5;241m.[39mextensions,
    [1;32m    248[0m )
    [0;32m--> 249[0m [43m[49m[38;5;28;43;01mwith[39;49;00m[43m [49m[43mmap_httpcore_exceptions[49m[43m([49m[43m)[49m[43m:[49m
    [1;32m    250[0m [43m    [49m[43mresp[49m[43m [49m[38;5;241;43m=[39;49m[43m [49m[38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_pool[49m[38;5;241;43m.[39;49m[43mhandle_request[49m[43m([49m[43mreq[49m[43m)[49m
    [1;32m    252[0m [38;5;28;01massert[39;00m [38;5;28misinstance[39m(resp[38;5;241m.[39mstream, typing[38;5;241m.[39mIterable)

    File [0;32m/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158[0m, in [0;36m_GeneratorContextManager.__exit__[0;34m(self, typ, value, traceback)[0m
    [1;32m    156[0m     value [38;5;241m=[39m typ()
    [1;32m    157[0m [38;5;28;01mtry[39;00m:
    [0;32m--> 158[0m     [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mgen[49m[38;5;241;43m.[39;49m[43mthrow[49m[43m([49m[43mvalue[49m[43m)[49m
    [1;32m    159[0m [38;5;28;01mexcept[39;00m [38;5;167;01mStopIteration[39;00m [38;5;28;01mas[39;00m exc:
    [1;32m    160[0m     [38;5;66;03m# Suppress StopIteration *unless* it's the same exception that[39;00m
    [1;32m    161[0m     [38;5;66;03m# was passed to throw().  This prevents a StopIteration[39;00m
    [1;32m    162[0m     [38;5;66;03m# raised inside the "with" statement from being suppressed.[39;00m
    [1;32m    163[0m     [38;5;28;01mreturn[39;00m exc [38;5;129;01mis[39;00m [38;5;129;01mnot[39;00m value

    File [0;32m~/go/github.com/Fewsats/l402-python/venv/lib/python3.12/site-packages/httpx/_transports/default.py:118[0m, in [0;36mmap_httpcore_exceptions[0;34m()[0m
    [1;32m    115[0m     [38;5;28;01mraise[39;00m
    [1;32m    117[0m message [38;5;241m=[39m [38;5;28mstr[39m(exc)
    [0;32m--> 118[0m [38;5;28;01mraise[39;00m mapped_exc(message) [38;5;28;01mfrom[39;00m[38;5;250m [39m[38;5;21;01mexc[39;00m

    [0;31mReadTimeout[0m: The read operation timed out

``` python
r = get_payment_request(o['payment_request_url'], o['payment_context_token'], o['offers'][0]['offer_id'], 'lightning')
r
```

    HTTPStatusError: Server error '500 Internal Server Error' for url 'https://hub-5n97k.ondigitalocean.app/v0/l402/payment-request'
    For more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/500
    [0;31m---------------------------------------------------------------------------[0m
    [0;31mHTTPStatusError[0m                           Traceback (most recent call last)
    Cell [0;32mIn[13], line 1[0m
    [0;32m----> 1[0m r [38;5;241m=[39m [43mget_payment_request[49m[43m([49m[43mo[49m[43m[[49m[38;5;124;43m'[39;49m[38;5;124;43mpayment_request_url[39;49m[38;5;124;43m'[39;49m[43m][49m[43m,[49m[43m [49m[43mo[49m[43m[[49m[38;5;124;43m'[39;49m[38;5;124;43mpayment_context_token[39;49m[38;5;124;43m'[39;49m[43m][49m[43m,[49m[43m [49m[43mo[49m[43m[[49m[38;5;124;43m'[39;49m[38;5;124;43moffers[39;49m[38;5;124;43m'[39;49m[43m][49m[43m[[49m[38;5;241;43m0[39;49m[43m][49m[43m[[49m[38;5;124;43m'[39;49m[38;5;124;43moffer_id[39;49m[38;5;124;43m'[39;49m[43m][49m[43m,[49m[43m [49m[38;5;124;43m'[39;49m[38;5;124;43mlightning[39;49m[38;5;124;43m'[39;49m[43m)[49m
    [1;32m      2[0m r

    Cell [0;32mIn[11], line 17[0m, in [0;36mget_payment_request[0;34m(payment_request_url, payment_context_token, offer_id, payment_method, chain, asset)[0m
    [1;32m      9[0m data [38;5;241m=[39m {
    [1;32m     10[0m     [38;5;124m"[39m[38;5;124moffer_id[39m[38;5;124m"[39m: offer_id,
    [1;32m     11[0m     [38;5;124m"[39m[38;5;124mpayment_method[39m[38;5;124m"[39m: payment_method,
    [0;32m   (...)[0m
    [1;32m     14[0m     [38;5;124m"[39m[38;5;124mpayment_context_token[39m[38;5;124m"[39m: payment_context_token
    [1;32m     15[0m }
    [1;32m     16[0m r [38;5;241m=[39m httpx[38;5;241m.[39mpost(payment_request_url, json[38;5;241m=[39mdata)
    [0;32m---> 17[0m [43mr[49m[38;5;241;43m.[39;49m[43mraise_for_status[49m[43m([49m[43m)[49m
    [1;32m     18[0m [38;5;28;01mreturn[39;00m r[38;5;241m.[39mjson()

    File [0;32m~/go/github.com/Fewsats/l402-python/venv/lib/python3.12/site-packages/httpx/_models.py:829[0m, in [0;36mResponse.raise_for_status[0;34m(self)[0m
    [1;32m    827[0m error_type [38;5;241m=[39m error_types[38;5;241m.[39mget(status_class, [38;5;124m"[39m[38;5;124mInvalid status code[39m[38;5;124m"[39m)
    [1;32m    828[0m message [38;5;241m=[39m message[38;5;241m.[39mformat([38;5;28mself[39m, error_type[38;5;241m=[39merror_type)
    [0;32m--> 829[0m [38;5;28;01mraise[39;00m HTTPStatusError(message, request[38;5;241m=[39mrequest, response[38;5;241m=[39m[38;5;28mself[39m)

    [0;31mHTTPStatusError[0m: Server error '500 Internal Server Error' for url 'https://hub-5n97k.ondigitalocean.app/v0/l402/payment-request'
    For more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/500

------------------------------------------------------------------------

<a
href="https://github.com/Fewsats/l402-python/blob/main/l402/payment_clients.py#L79"
target="_blank" style="float:right; font-size:smaller">source</a>

### Client

>  Client (lightning_provider=None, credit_card_provider=None,
>              onchain_provider=None, fewsats_provider=None)

*Base class for objects needing a basic `__repr__`*

``` python
w = create_test_wallet(fund=False, chain=chain)
c = Client(onchain_provider=CoinbaseProvider(wallet=w, asset='usdc'))
try:
    c.pay(o)
except Exception as e:
    print(e)
```

    Insufficient funds: have 0, need 1.

## Fewsats Client

------------------------------------------------------------------------

<a
href="https://github.com/Fewsats/l402-python/blob/main/l402/payment_clients.py#L124"
target="_blank" style="float:right; font-size:smaller">source</a>

### Fewsats

>  Fewsats (api_key:str=None,
>               base_url:str='https://hub-5n97k.ondigitalocean.app')

*Initialize self. See help(type(self)) for accurate signature.*

``` python
f = Fewsats()
f = Fewsats(base_url='http://localhost:8000', api_key='yQbJPudW-nqiTyx880t8G83oLGyoR-RlnrLDmEe0D58')
f.get_payment_methods()
```

    [{'id': 1,
      'last4': '4242',
      'brand': 'visa',
      'exp_month': 12,
      'exp_year': 2034,
      'is_default': False},
     {'id': 4,
      'last4': '4242',
      'brand': 'Visa',
      'exp_month': 12,
      'exp_year': 2034,
      'is_default': True}]

``` python
c = Client(fewsats_provider=Fewsats(base_url='http://localhost:8000', api_key='yQbJPudW-nqiTyx880t8G83oLGyoR-RlnrLDmEe0D58'))
err = None
try:
    c.pay(o)
except Exception as e:
    print(e.response.text)
```

    {'payment_request_url': 'https://hub-5n97k.ondigitalocean.app/v0/l402/payment-request', 'payment_context_token': 'a1700b1a-8325-47a9-902a-f90e82d21427', 'payment_method': 'onchain', 'offer': {'offer_id': 'f52bcccd-1057-4204-b1ae-01707bfe29af', 'amount': 1, 'currency': 'USD', 'description': 'Purchase 1 credit for API access', 'title': '1 Credit Package', 'type': 'one-time', 'payment_methods': ['onchain']}}
    http://localhost:8000
    yQbJPudW-nqiTyx880t8G83oLGyoR-RlnrLDmEe0D58
    Traceback (most recent call last):
      File "/usr/local/lib/python3.12/site-packages/ninja/operation.py", line 341, in run
        result = await self.view_func(request, **values)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
      File "/opt/hub_api/l402/api/common/decorators.py", line 17, in wrapper
        return await func(request, *args, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
      File "/opt/hub_api/l402/api/v0/views.py", line 32, in l402_create_purchase_from_offer_v0
        return await purchase_from_offer(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^
      File "/usr/local/lib/python3.12/site-packages/asgiref/sync.py", line 518, in thread_handler
        raise exc_info[1]
      File "/opt/hub_api/common/decorators/aatomic.py", line 48, in wrapper
        return await fun(*args, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^
      File "/opt/hub_api/l402/workflow.py", line 424, in purchase_from_offer
        return await purchase_with_onchain(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
      File "/usr/local/lib/python3.12/site-packages/asgiref/sync.py", line 518, in thread_handler
        raise exc_info[1]
      File "/opt/hub_api/common/decorators/aatomic.py", line 48, in wrapper
        return await fun(*args, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^
      File "/opt/hub_api/l402/workflow.py", line 496, in purchase_with_onchain
        transfer = wallet.transfer(
                   ^^^^^^^^^^^^^^^^
      File "/usr/local/lib/python3.12/site-packages/cdp/wallet.py", line 466, in transfer
        return self.default_address.transfer(amount, asset_id, destination, gasless, skip_batching)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
      File "/usr/local/lib/python3.12/site-packages/cdp/wallet_address.py", line 122, in transfer
        self._ensure_sufficient_balance(normalized_amount, asset_id)
      File "/usr/local/lib/python3.12/site-packages/cdp/wallet_address.py", line 463, in _ensure_sufficient_balance
        raise InsufficientFundsError(expected=amount, exact=current_balance)
    cdp.errors.InsufficientFundsError: Insufficient funds: have 0.499997, need 1.

``` python
err.response.json()
```

    AttributeError: 'NoneType' object has no attribute 'response'
    [0;31m---------------------------------------------------------------------------[0m
    [0;31mAttributeError[0m                            Traceback (most recent call last)
    Cell [0;32mIn[18], line 1[0m
    [0;32m----> 1[0m [43merr[49m[38;5;241;43m.[39;49m[43mresponse[49m[38;5;241m.[39mjson()

    [0;31mAttributeError[0m: 'NoneType' object has no attribute 'response'

``` python
try:
    f.pay(o)
except Exception as e:
    print(e)
```

    name 'f' is not defined

``` python
f = Fewsats()
try:
    f._pay_onchain(address=r['payment_request']['address'], amount="0.000001", chain='base-mainnet', asset='usdc')
except Exception as e:
    print(e)
```

    {'address': '0x114113186ca748Ea629A08B762df34a93f4C7e64', 'amount': '0.000001', 'chain': 'base-mainnet', 'asset': 'usdc'}
    The read operation timed out

``` python
o, r
```

    ({'offers': [{'amount': 1,
        'currency': 'USD',
        'description': 'Purchase 1 credit for API access',
        'offer_id': '33d08b4a-1589-4519-a24f-ba67e2166f0b',
        'payment_methods': ['onchain'],
        'title': '1 Credit Package',
        'type': 'one-time'}],
      'payment_context_token': 'd5607f07-3ecd-4f84-a9f9-74db7f922760',
      'payment_request_url': 'http://localhost:9000/payment_request',
      'version': '0.2.2'},
     {'expires_at': '2025-01-25T18:21:42.339161+00:00',
      'offer_id': '33d08b4a-1589-4519-a24f-ba67e2166f0b',
      'payment_request': {'address': '0xAa4b26Ca04692E6cAA310Dc05Feaf1dE75943d62',
       'chain': 'base-mainnet',
       'asset': 'usdc'},
      'version': '0.2.2'})
